version: '3'

services:
  # Site
  webserver:
    image: nginx:stable-alpine
    container_name: webserver
    ports:
      - "8080:80"
    volumes:
      - ./:/var/www/html
      - ./.config/nginx:/etc/nginx
    depends_on:
      - php-fpm
      - db
      - redis
    restart: always
    labels: 
      - "traefik.enable=true"
      - "traefik.backend=swor-api"
      - "traefik.http.routers.api.rule=Host(`api.swor-jdr.com`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.docker.network=web"
      - "traefik.port=8080"
    networks: 
      - sidious-net
      - web

  # DB
  db:
    image: mysql:5.7.29
    container_name: db
    restart: unless-stopped
    tty: true
    ports:
      - "3306:3306"
    environment:
      MYSQL_PASSWORD: secret
      MYSQL_ROOT_PASSWORD: secret
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    networks:
      - sidious-net
    volumes: 
      - "dbsidious:/data"

  # PHP
  php-fpm:
    build: 
      context: .
      dockerfile: dockerfile
    container_name: php-fpm
    depends_on: 
      - db
    volumes: 
      - ./:/var/www/html
    ports:
      - "9000:9000"
    networks: 
      - sidious-net

  # Node
  node: 
    image: node:12-alpine
    container_name: node
    volumes:
      - ./:/var/www/html
    working_dir: /var/www/html
    entrypoint: ['npm', '--no-bin-links']
    networks: 
      - sidious-net

  # Redis
  redis: 
    image: 'redis:latest'
    container_name: redis
    environment: 
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DISABLE_COMMANDS=FLUSHDB,FLUSHALL,CONFIG
    command: "redis-server --appendonly yes"
    volumes: 
      - "redis_data:/data"
    networks: 
      - sidious-net
      - web

  # Laravel CLI
  artisan:
    build: 
      context: .
      dockerfile: dockerfile
    container_name: artisan
    volumes: 
      - ./:/var/www/html
    depends_on: 
      - php-fpm
      - db
    working_dir: /var/www/html
    entrypoint: ['php', '/var/www/html/artisan']
    networks: 
      - sidious-net

#Docker Networks
networks:
  sidious-net:
    driver: bridge
  web:
    external:
      name: web

#Volumes
volumes:
  dbsidious:
    driver: local
  redis_data:
